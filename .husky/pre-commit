#!/bin/sh

echo "ğŸ”„ Running pre-commit hooks..."

# Run linting and formatting
echo "ğŸ“‹ Running lint and formatting..."
bun run check:code
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed"
  exit 1
fi

# Run type checking
echo "ğŸ” Running type checks..."
bun run check:types
if [ $? -ne 0 ]; then
  echo "âŒ Type checking failed"
  exit 1
fi

# Check JSDoc documentation is up-to-date
echo "ğŸ“š Generating JSDoc documentation..."
bun run docs:generate
git add docs

# Run markdown linting
echo "ğŸ“ Running markdown lint..."
bun run check:md
if [ $? -ne 0 ]; then
  echo "âŒ Markdown linting failed"
  exit 1
fi

# Run spell checking
echo "ğŸ” Running spell checking..."
bun run check:spell
if [ $? -ne 0 ]; then
  echo "âŒ Spell checking failed"
  exit 1
fi

# Validate CHANGELOG.md changes
echo "ğŸ“‹ Validating CHANGELOG.md..."

# Check if CHANGELOG.md is staged for commit
if git diff --cached --name-only | grep -q CHANGELOG.md; then
  # Ensure changes are only in UNRELEASED section
  if ! grep -q "^## UNRELEASED" CHANGELOG.md; then
    echo "âŒ CHANGELOG.md missing UNRELEASED section"
    exit 1
  fi

  # Get line range of UNRELEASED section
  start_line=$(grep -n "^## UNRELEASED" CHANGELOG.md | cut -d: -f1)
  end_line=$(tail -n +$((start_line + 1)) CHANGELOG.md | grep -n "^## " | head -1 | cut -d: -f1)
  end_line=${end_line:+$((start_line + end_line - 1))}

  # Check if staged changes are outside UNRELEASED section
  if git diff --cached --unified=0 CHANGELOG.md | grep "^@@" | grep -qv "+$((start_line + 1)),"; then
    echo "âŒ CHANGELOG.md changes must be in UNRELEASED section only"
    exit 1
  fi

  echo "âœ… CHANGELOG.md validation passed"
else
  echo "  CHANGELOG.md not modified, skipping validation"
fi

echo "âœ… Pre-commit hooks completed successfully"
